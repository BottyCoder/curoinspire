
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <meta name="googlebot" content="noindex, nofollow">
    <title>Combined Billing Dashboard</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Combined Billing Dashboard</h1>
            <div id="billing-period">
                Period: <span id="current-period">Loading...</span>
            </div>
        </div>

        <div class="stats-grid">
            <!-- Inspire Messages -->
            <div class="stat-card">
                <h2>Inspire Messages</h2>
                <p id="inspire-count">0</p>
                <p class="subtitle">Unique Clients: <span id="inspire-clients">0</span></p>
            </div>

            <!-- Customer Messages -->
            <div class="stat-card">
                <h2>Customer Messages</h2>
                <p id="customer-count">0</p>
                <p class="subtitle">Unique Numbers: <span id="customer-numbers">0</span></p>
            </div>

            <!-- Session Cost -->
            <div class="stat-card">
                <h2>Session Cost</h2>
                <p class="cost-display" onclick="toggleSessionDetails()">
                    $<span id="session-cost-usd">0.00</span>
                    <span class="currency-conversion">(R<span id="session-cost-zar">0.00</span>)</span>
                    <span class="dropdown-arrow">â–¼</span>
                </p>
                <div id="session-details" class="dropdown-content">
                    <div class="fee-section">
                        <h3>Session Details</h3>
                        <p>Count: <span id="session-count">0</span></p>
                    </div>
                </div>
            </div>

            <!-- Total Messages Cost -->
            <div class="stat-card">
                <h2>Total Messages Cost</h2>
                <p class="cost-display">
                    $<span id="total-cost-usd">0.00</span>
                    <span class="currency-conversion">(R<span id="total-cost-zar">0.00</span>)</span>
                </p>
            </div>

            <!-- Exchange Rate -->
            <div class="stat-card">
                <h2>Exchange Rate</h2>
                <p id="exchange-rate">1 USD = -- ZAR</p>
                <p class="small-text">Excludes bank charges</p>
            </div>
        </div>

        <div class="messages-section">
            <div class="tab-container">
                <button class="tab-button active" onclick="showTab('inspire')">Inspire Messages</button>
                <button class="tab-button" onclick="showTab('customer')">Customer Messages</button>
            </div>

            <div id="inspire-tab" class="tab-content active">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Client GUID</th>
                            <th>Tracking Code</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="inspire-messages"></tbody>
                </table>
            </div>

            <div id="customer-tab" class="tab-content">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Mobile Number</th>
                            <th>Message Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="customer-messages"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let exchangeRate = 19.08; // Default rate

        async function fetchExchangeRate() {
            try {
                const response = await fetch('/billing/exchange-rate');
                const data = await response.json();
                exchangeRate = data.rate;
                document.getElementById('exchange-rate').textContent = `1 USD = ${exchangeRate.toFixed(2)} ZAR`;
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
            }
        }

        function toggleSessionDetails() {
            const details = document.getElementById('session-details');
            if (details) {
                details.classList.toggle('show');
            }
        }

        async function fetchStats() {
            try {
                const response = await fetch('/combined/stats');
                const data = await response.json();

                document.getElementById('inspire-count').textContent = data.inspire.count;
                document.getElementById('inspire-clients').textContent = data.inspire.uniqueClients;
                document.getElementById('customer-count').textContent = data.customer.count;
                document.getElementById('customer-numbers').textContent = data.customer.uniqueNumbers;
                document.getElementById('session-count').textContent = data.billing.sessionCount;
                
                const sessionCost = data.billing.sessionCount * 0.0176; // $0.0176 per session
                const totalCost = data.billing.totalCost;

                // Update USD amounts
                document.getElementById('session-cost-usd').textContent = sessionCost.toFixed(2);
                document.getElementById('total-cost-usd').textContent = totalCost.toFixed(2);

                // Update ZAR amounts
                document.getElementById('session-cost-zar').textContent = (sessionCost * exchangeRate).toFixed(2);
                document.getElementById('total-cost-zar').textContent = (totalCost * exchangeRate).toFixed(2);

                document.getElementById('current-period').textContent = 
                    `${new Date(data.startDate).toLocaleDateString()} - ${new Date(data.endDate).toLocaleDateString()}`;
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }

        async function fetchMessages() {
            try {
                const response = await fetch('/combined/recent-messages');
                const data = await response.json();

                const inspireMessages = data.messages.filter(msg => msg.tracking_code);
                const customerMessages = data.messages.filter(msg => !msg.tracking_code);

                document.getElementById('inspire-messages').innerHTML = inspireMessages
                    .map(msg => `
                        <tr>
                            <td>${new Date(msg.timestamp).toLocaleString()}</td>
                            <td>${msg.client_guid || '-'}</td>
                            <td>${msg.tracking_code}</td>
                            <td>${msg.status}</td>
                        </tr>
                    `).join('');

                document.getElementById('customer-messages').innerHTML = customerMessages
                    .map(msg => `
                        <tr>
                            <td>${new Date(msg.timestamp).toLocaleString()}</td>
                            <td>${msg.mobile_number}</td>
                            <td>${msg.message_type || 'standard'}</td>
                            <td>${msg.status}</td>
                        </tr>
                    `).join('');
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Initial load
        fetchExchangeRate().then(() => {
            fetchStats();
            fetchMessages();
        });

        // Refresh every 5 minutes
        setInterval(() => {
            fetchStats();
            fetchMessages();
        }, 300000);
    </script>

    <style>
        .tab-container {
            margin: 20px 0;
        }
        .tab-button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            background: #f0f0f0;
            cursor: pointer;
        }
        .tab-button.active {
            background: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .subtitle {
            font-size: 0.9em;
            color: #666;
        }
    </style>
</body>
</html>
