
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Billing Dashboard</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>Billing Dashboard</h1>
            <div id="billing-period" class="billing-period">
                Billing Period: <span id="current-period">Loading...</span>
            </div>
            <div class="exchange-rate">
                Exchange Rate: <span id="exchange-rate">1 USD = -- ZAR</span><br>
                <span class="small-text">Excludes bank charges</span>
            </div>
        </div>
        
        <div class="stats-grid">
            <!-- Total Messages -->
            <div class="stat-card">
                <h2>Total Messages</h2>
                <p id="total-messages">0</p>
            </div>
            
            <!-- Billable Sessions -->
            <div class="stat-card">
                <h2>Billable Sessions</h2>
                <p id="billable-sessions">0</p>
            </div>
            
            <!-- Monthly Active Users -->
            <div class="stat-card">
                <h2>Monthly Active Users</h2>
                <p id="monthly-users">0</p>
            </div>

            <!-- Session Cost -->
            <div class="stat-card">
                <h2>Session Cost</h2>
                <p class="cost-display" onclick="toggleSessionDetails()">
                    $<span id="session-cost-usd">0.00</span>
                    <span class="currency-conversion">(R<span id="session-cost-zar">0.00</span>)</span>
                    <span class="dropdown-arrow">â–¼</span>
                </p>
                <div id="session-details" class="dropdown-content">
                    <div class="fee-section">
                        <h3>Carrier Fees</h3>
                        <p>Count: <span id="carrier-count">0</span></p>
                        <p>Total: $<span id="carrier-total">0.00</span></p>
                    </div>
                    <div class="fee-section">
                        <h3>Utility Fees</h3>
                        <p>Count: <span id="utility-count">0</span></p>
                        <p>Total: $<span id="utility-total">0.00</span></p>
                    </div>
                </div>
            </div>
            
            <!-- MAU Cost -->
            <div class="stat-card">
                <h2>MAU Cost</h2>
                <p class="cost-display">
                    $<span id="mau-cost-usd">0.00</span>
                    <span class="currency-conversion">(R<span id="mau-cost-zar">0.00</span>)</span>
                </p>
            </div>
            
            <!-- Total Cost -->
            <div class="stat-card">
                <h2>Total Cost</h2>
                <p class="cost-display">
                    $<span id="total-cost-usd">0.00</span>
                    <span class="currency-conversion">(R<span id="total-cost-zar">0.00</span>)</span>
                </p>
            </div>
        </div>
    </div>

    <script>
        function toggleSessionDetails() {
            const details = document.getElementById('session-details');
            if (details) {
                details.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const sessionCost = document.querySelector('.text-2xl.font-semibold');
            const details = document.getElementById('session-details');
            if (sessionCost && details && !sessionCost.contains(e.target) && !details.contains(e.target)) {
                details.classList.add('hidden');
            }
        });

        function formatBillingPeriod() {
            const now = new Date();
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return `${months[now.getMonth()]} ${now.getFullYear()}`;
        }

        async function fetchData() {
            document.getElementById('current-period').textContent = formatBillingPeriod();
            try {
                const [statsRes, rateRes] = await Promise.all([
                    fetch('/billing/stats'),
                    fetch('/billing/exchange-rate')
                ]);

                if (!statsRes.ok || !rateRes.ok) {
                    throw new Error('Failed to fetch data');
                }

                const stats = await statsRes.json();
                const { rate } = await rateRes.json();
                
                // Update exchange rate display
                document.getElementById('exchange-rate').textContent = `1 USD = ${rate.toFixed(2)} ZAR`;
                
                // Update metrics
                document.getElementById('total-messages').textContent = stats.totalMessages;
                document.getElementById('billable-sessions').textContent = stats.billableSessions || 0;
                document.getElementById('monthly-users').textContent = stats.monthlyActiveUsers || 0;
                
                // Update costs
                document.getElementById('session-cost-usd').textContent = stats.sessionCost?.toFixed(2) || '0.00';
                document.getElementById('session-cost-zar').textContent = ((stats.sessionCost || 0) * rate).toFixed(2);
                
                // Update carrier and utility details
                document.getElementById('carrier-count').textContent = stats.carrierCount || 0;
                document.getElementById('carrier-total').textContent = stats.carrierTotal?.toFixed(2) || '0.00';
                document.getElementById('utility-count').textContent = stats.utilityCount || 0;
                document.getElementById('utility-total').textContent = stats.utilityTotal?.toFixed(2) || '0.00';
                
                document.getElementById('mau-cost-usd').textContent = stats.mauCost?.toFixed(2) || '0.00';
                document.getElementById('mau-cost-zar').textContent = ((stats.mauCost || 0) * rate).toFixed(2);
                
                document.getElementById('total-cost-usd').textContent = stats.totalCost?.toFixed(2) || '0.00';
                document.getElementById('total-cost-zar').textContent = ((stats.totalCost || 0) * rate).toFixed(2);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        fetchData();
        setInterval(fetchData, 60000); // Refresh every minute
    </script>
</body>
</html>
